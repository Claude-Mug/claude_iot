<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration Claude-IoT</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --error-color: #dc3545;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --border-radius: 8px;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: var(--bg-light); color: #333; }
        .container { max-width: 1200px; margin: auto; background: var(--bg-white); padding: 30px; border-radius: var(--border-radius); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: var(--primary-color); border-bottom: 2px solid #e9ecef; padding-bottom: 10px; margin-top: 25px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input[type="text"], input[type="password"], textarea { 
            width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; 
            transition: border-color 0.3s; 
        }
        input:focus, textarea:focus { border-color: var(--primary-color); outline: none; }
        button { 
            background-color: var(--primary-color); color: white; padding: 10px 18px; border: none; border-radius: 4px; 
            cursor: pointer; margin-right: 10px; transition: background-color 0.3s, transform 0.1s; font-weight: 500;
        }
        button:hover { background-color: #0056b3; transform: translateY(-1px); }
        .delete-btn { background-color: var(--error-color); }
        .delete-btn:hover { background-color: #bd2130; }
        
        .response { 
            margin-top: 15px; padding: 15px; background-color: #e9f2ff; border-left: 5px solid var(--primary-color); 
            border-radius: 4px; white-space: pre-wrap; word-break: break-all; 
        }
        .error { color: var(--error-color); font-weight: bold; }
        .success { color: var(--success-color); font-weight: bold; }
        
        /* Styles d'Authentification */
        #auth-form { padding: 30px; background-color: #fff3cd; border-radius: var(--border-radius); border: 1px solid #ffeeba; }
        #auth-form button { background-color: var(--success-color); }
        #auth-form button:hover { background-color: #1e7e34; }
        #app-content { display: none; }
        
        /* Styles de Tableau */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; border: 1px solid #dee2e6; border-radius: var(--border-radius); overflow: hidden; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background-color: var(--primary-color); color: white; font-weight: 600; text-transform: uppercase; }
        tr:last-child td { border-bottom: none; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .latest-row { background-color: #ffeaa7 !important; font-weight: bold; border-left: 4px solid orange; }
    </style>
</head>
<body>

<div class="container">
    <h1>üõ∞Ô∏è Administration Claude-IoT</h1>

    <!-- Formulaire d'Authentification -->
    <div id="auth-form">
        <h2>Authentification Requise</h2>
        <div class="form-group">
            <label for="username">Nom d'utilisateur:</label>
            <input type="text" id="username" value="Claude-Mug" required>
        </div>
        <div class="form-group">
            <label for="password">Mot de passe:</label>
            <input type="password" id="password" value="Moscouw03" required>
        </div>
        <button onclick="handleLogin()">Se connecter</button>
        <p id="auth-status" class="error"></p>
    </div>

    <!-- Contenu de l'Application (Visible apr√®s connexion) -->
    <div id="app-content">

        <!-- Envoi de Commande -->
        <h2>üì® 1. Envoyer une Nouvelle Commande (Vers l'ESP)</h2>
        <div class="form-group">
            <label for="command-input">Commande (Ex: LED:ON, Ventilateur:OFF) :</label>
            <input type="text" id="command-input" placeholder="ventilateur -> ON" required>
        </div>
        <button onclick="sendCommand()">Envoyer et Enregistrer</button>
        <div id="command-response" class="response"></div>
        
        <hr>

        <!-- Affichage des Commandes -->
        <h2>üìú 2. Historique des Commandes (Max 50)</h2>
        <button onclick="getAllCommands()">Rafra√Æchir les Commandes</button>
        <button class="delete-btn" onclick="clearCommands()">Effacer TOUT l'Historique</button>
        <div id="all-commands-display" class="response">
            <p>Cliquez sur "Rafra√Æchir les Commandes" pour charger les donn√©es de la base.</p>
        </div>

        <hr>

        <!-- Affichage des Messages ESP (RAM) -->
        <h2>üì° 3. Messages R√©cents des Dispositifs ESP (RAM)</h2>
        <p>Ces messages sont des √©tats √©ph√©m√®res, nettoy√©s toutes les 15 minutes.</p>
        <button onclick="getEspMessages()">Rafra√Æchir les Messages ESP</button>
        <div id="esp-messages-display" class="response">
             <p>Aucun message affich√©.</p>
        </div>

        <hr>

        <!-- Statut du Serveur et Infos DB -->
        <h2>üìä 4. Statut du Serveur et Infos Routes</h2>
        <button onclick="getServerStatus()">Afficher/Rafra√Æchir le Statut</button>
        <div id="status-response" class="response">
            <p>Affiche les informations syst√®me et l'√©tat de la connexion DB.</p>
        </div>

    </div>
</div>

<script>
    // --- Configuration ---
    const VALID_USERNAME = 'Claude-Mug';
    const VALID_PASSWORD = 'Moscouw03';
    let isAuthenticated = false;

    // --- Authentification ---

    function handleLogin() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const statusElement = document.getElementById('auth-status');

        if (username === VALID_USERNAME && password === VALID_PASSWORD) {
            isAuthenticated = true;
            statusElement.textContent = 'Connexion r√©ussie!';
            statusElement.className = 'success';
            document.getElementById('auth-form').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            
            // Charge les donn√©es par d√©faut au succ√®s de la connexion
            getAllCommands();
            getServerStatus();
        } else {
            statusElement.textContent = 'Erreur: Nom d\'utilisateur ou mot de passe incorrect.';
            statusElement.className = 'error';
        }
    }

    // --- Fonctions Utilitaires ---

    async function securedFetch(url, options = {}) {
        if (!isAuthenticated) {
            console.error("Non authentifi√©.");
            alert("Session expir√©e ou non authentifi√©e. Veuillez vous reconnecter.");
            document.getElementById('auth-form').style.display = 'block';
            document.getElementById('app-content').style.display = 'none';
            return { ok: false, status: 401 };
        }
        
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorText = await response.text();
                return { ok: false, status: response.status, text: errorText };
            }
            // Tente de parser JSON, sinon retourne null pour JSON
            const contentType = response.headers.get('content-type');
            let json = null;
            let text = '';
            if (contentType && contentType.includes('application/json')) {
                json = await response.json();
            } else {
                text = await response.text();
            }
            return { ok: true, status: response.status, text: text, json: json };
        } catch (error) {
            console.error('Erreur r√©seau ou Fetch:', error);
            return { ok: false, status: 0, text: `Erreur r√©seau: ${error.message}` };
        }
    }

    function formatTime(timestamp) {
        if (!timestamp) return 'N/A';
        return new Date(timestamp).toLocaleString('fr-FR');
    }

    // --- 1. Envoi de Commande ---

    async function sendCommand() {
        const commandValue = document.getElementById('command-input').value.trim();
        const responseDiv = document.getElementById('command-response');
        responseDiv.innerHTML = 'Envoi...';
        
        if (!commandValue) {
            responseDiv.innerHTML = '<span class="error">Veuillez entrer une commande.</span>';
            return;
        }

        const response = await securedFetch('/commande_post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command: commandValue })
        });

        if (response.ok && response.json.success) {
            responseDiv.innerHTML = `<span class="success">‚úÖ Commande enregistr√©e/mise √† jour : ${commandValue}. Statut: ${response.json.message}</span>`;
            // Rafra√Æchit le tableau des commandes apr√®s l'envoi
            getAllCommands();
        } else {
            const msg = response.json ? response.json.message : response.text;
            responseDiv.innerHTML = `<span class="error">‚ùå Erreur d'enregistrement (Statut: ${response.status}) : ${msg}</span>`;
        }
    }
    
    // --- 2. Historique des Commandes (Affichage et Suppression) ---

    async function deleteCommand(commandId) {
        if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la commande ID ${commandId} ?`)) {
            return;
        }

        // NOTE: Cette route DELETE doit √™tre impl√©ment√©e dans routesProvider.js
        const deleteRoute = `/commande/${commandId}`; 
        
        // Simuler une requ√™te DELETE, car la route n'est pas encore impl√©ment√©e
        const responseDiv = document.getElementById('all-commands-display');
        responseDiv.innerHTML = `<p class="error">Fonction de suppression non impl√©ment√©e c√¥t√© serveur (route ${deleteRoute}).</p>`;
        
        /*
        // Code √† utiliser quand la route DELETE sera pr√™te:
        const response = await securedFetch(deleteRoute, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert(`Commande ID ${commandId} supprim√©e avec succ√®s!`);
            getAllCommands(); // Rafra√Æchir le tableau
        } else {
            alert(`Erreur lors de la suppression (Statut: ${response.status}).`);
        }
        */
    }

    async function clearCommands() {
        // NOTE: Cette fonctionnalit√© n'est pas encore impl√©ment√©e (route DELETE globale requise)
        alert("La fonctionnalit√© d'effacer TOUT l'historique n'est pas impl√©ment√©e. Vous devez ajouter une route DELETE sp√©cifique (ex: /all_commands) au serveur.");
    }


    async function getAllCommands() {
        const responseDiv = document.getElementById('all-commands-display');
        responseDiv.innerHTML = 'Chargement des commandes...';

        const response = await securedFetch('/all_commands');

        if (response.ok && response.json) {
            const data = response.json;
            if (data.success && data.commands && data.commands.length > 0) {
                let html = `<h4>Total Commandes: ${data.count} (Max 50)</h4>`;
                html += '<table><thead><tr><th>ID</th><th>Commande</th><th>Date de Demande</th><th>Action</th></tr></thead><tbody>';
                
                data.commands.forEach((cmd, index) => {
                    const rowClass = index === 0 ? 'latest-row' : ''; // Derni√®re commande est la premi√®re (tri DESC)
                    html += `<tr class="${rowClass}">
                                <td>${cmd.id}</td>
                                <td>${cmd.command}</td>
                                <td>${formatTime(cmd.created_at)}</td>
                                <td>
                                    <button class="delete-btn" onclick="deleteCommand(${cmd.id})">Supprimer</button>
                                </td>
                             </tr>`;
                });
                html += '</tbody></table>';
                responseDiv.innerHTML = html;
            } else {
                responseDiv.innerHTML = '<span class="error">Aucune commande trouv√©e dans la base de donn√©es.</span>';
            }
        } else {
            responseDiv.innerHTML = `<span class="error">‚ùå Erreur lors de la r√©cup√©ration des commandes (Statut: ${response.status}). ${response.text || ''}</span>`;
        }
    }
    
    // --- 3. Affichage des messages ESP (RAM) ---

    async function getEspMessages() {
        const responseDiv = document.getElementById('esp-messages-display');
        responseDiv.innerHTML = 'Chargement des messages RAM...';

        const response = await securedFetch('/messages');

        if (response.ok && response.json) {
            const data = response.json;
            if (data.success && data.messages.length > 0) {
                let html = `<h4>Total Messages en RAM: ${data.count}</h4><table><thead><tr><th>Device ID</th><th>Message</th><th>Date/Heure</th></tr></thead><tbody>`;
                data.messages.forEach(msg => {
                    html += `<tr>
                                <td>${msg.device_id}</td>
                                <td>${msg.message}</td>
                                <td>${formatTime(msg.created_at)}</td>
                            </tr>`;
                });
                html += '</tbody></table>';
                responseDiv.innerHTML = html;
            } else {
                responseDiv.innerHTML = '<span class="error">Aucun message ESP en RAM.</span>';
            }
        } else {
            responseDiv.innerHTML = `<span class="error">‚ùå Erreur lors de la r√©cup√©ration des messages ESP (Statut: ${response.status}).</span>`;
        }
    }

    // --- 4. Affichage du Statut du Serveur ---

    async function getServerStatus() {
        const responseDiv = document.getElementById('status-response');
        responseDiv.innerHTML = 'V√©rification du statut...';

        const response = await securedFetch('/status');

        if (response.ok && response.json) {
            const data = response.json;
            let routesList = data.routes_available.map(r => `<li><code>${r}</code></li>`).join('');
            
            // Calcul de la capacit√© RAM utilis√©e (estimation fictive pour l'exemple)
            const ramUsage = Math.floor(Math.random() * 80) + 20; // Entre 20% et 100%
            
            let html = `
                <p><strong>Service:</strong> ${data.service}</p>
                <p><strong>Statut:</strong> <span class="${data.status === 'online' ? 'success' : 'error'}">${data.status}</span></p>
                <p><strong>Statut DB:</strong> ${data.db_status}</p>
                <p><strong>Capacit√©/RAM Utilis√©e (Simulation):</strong> ${ramUsage}%</p>
                <p><strong>Timestamp:</strong> ${formatTime(data.timestamp)}</p>
                
                <h4>Routes Disponibles (${data.routes_available.length}):</h4>
                <ul>${routesList}</ul>
            `;
            responseDiv.innerHTML = html;
        } else {
            responseDiv.innerHTML = `<span class="error">‚ùå Erreur lors de la r√©cup√©ration du statut (Statut: ${response.status}).</span>`;
        }
    }
    
    // Tente de se connecter au chargement 
    window.onload = handleLogin;
</script>

</body>
</html>
