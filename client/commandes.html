<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration Claude-IoT</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-top: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        .response { margin-top: 15px; padding: 15px; background-color: #e9ecef; border-radius: 4px; white-space: pre-wrap; word-break: break-all; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        #auth-form { padding: 30px; background-color: #ffe0b2; border-radius: 8px; }
        #app-content { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>

<div class="container">
    <h1>üîí Administration Claude-IoT</h1>

    <div id="auth-form">
        <h2>Authentification Requise</h2>
        <div class="form-group">
            <label for="username">Nom d'utilisateur:</label>
            <input type="text" id="username" value="Claude-Mug" required>
        </div>
        <div class="form-group">
            <label for="password">Mot de passe:</label>
            <input type="password" id="password" value="Moscouw03" required>
        </div>
        <button onclick="handleLogin()">Se connecter</button>
        <p id="auth-status" class="error"></p>
    </div>

    <div id="app-content">

        <h2>üì® 1. Envoyer une Nouvelle Commande (Vers l'ESP)</h2>
        <div class="form-group">
            <label for="command-input">Commande (Ex: LED:ON, Ventilateur:OFF):</label>
            <input type="text" id="command-input" placeholder="ventilateur -> ON" required>
        </div>
        <button onclick="sendCommand()">Envoyer et Enregistrer</button>
        <div id="command-response" class="response"></div>
        
        <hr>

        <h2>üìú 2. Historique des Commandes</h2>
        <button onclick="getAllCommands()">Afficher toutes les Commandes</button>
        <button onclick="getAndDisplayLastCommand()">Derni√®re Commande (Texte)</button>
        <div id="all-commands-display" class="response">Aucune donn√©e affich√©e.</div>

        <hr>

        <h2>üì° 3. Messages R√©cents des Dispositifs ESP (RAM)</h2>
        <p>Ces messages sont nettoy√©s toutes les 15 minutes.</p>
        <button onclick="getEspMessages()">Afficher les Messages ESP</button>
        <div id="esp-messages-display" class="response">Aucune donn√©e affich√©e.</div>

        <hr>

        <h2>üìä 4. Statut du Serveur et Infos Routes</h2>
        <button onclick="getServerStatus()">Afficher le Statut du Serveur</button>
        <div id="status-response" class="response"></div>

    </div>
</div>

<script>
    // --- Authentification Hardcod√©e ---
    const VALID_USERNAME = 'Claude-Mug';
    const VALID_PASSWORD = 'Moscouw03';
    let isAuthenticated = false;

    function handleLogin() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const statusElement = document.getElementById('auth-status');

        if (username === VALID_USERNAME && password === VALID_PASSWORD) {
            isAuthenticated = true;
            statusElement.textContent = 'Connexion r√©ussie!';
            statusElement.className = 'success';
            document.getElementById('auth-form').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
        } else {
            statusElement.textContent = 'Erreur: Nom d\'utilisateur ou mot de passe incorrect.';
            statusElement.className = 'error';
        }
    }

    // S√©curisation basique des requ√™tes (non-critique ici)
    async function securedFetch(url, options = {}) {
        if (!isAuthenticated) {
            alert("Erreur d'authentification. Veuillez vous reconnecter.");
            // Forcer la d√©connexion visuelle
            document.getElementById('auth-form').style.display = 'block';
            document.getElementById('app-content').style.display = 'none';
            return { ok: false, status: 401 };
        }
        
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                 // G√®re les erreurs HTTP c√¥t√© serveur
                return { ok: false, status: response.status, text: await response.text(), json: null };
            }
            return { ok: true, status: response.status, text: await response.text(), json: response.headers.get('content-type')?.includes('application/json') ? await response.json() : null };
        } catch (error) {
            console.error('Erreur r√©seau:', error);
            return { ok: false, status: 0, text: `Erreur r√©seau: ${error.message}`, json: null };
        }
    }

    // --- Fonctions d'Interaction avec les Routes ---

    // Fonction fictive (non impl√©ment√©e dans les routes actuelles) pour effacer la DB
    function clearCommands() {
        alert("La fonction d'effacement de la base de donn√©es n'est pas encore impl√©ment√©e sur le serveur.");
    }
    
    // 1. Envoi de Commande (vers le serveur pour √™tre stock√©e)
    async function sendCommand() {
        const commandValue = document.getElementById('command-input').value;
        const responseDiv = document.getElementById('command-response');
        if (!commandValue) {
            responseDiv.innerHTML = '<span class="error">Veuillez entrer une commande.</span>';
            return;
        }

        // NOTE: Ceci est une simulation. Dans la r√©alit√©, une commande doit √™tre transmise √† l'ESP.
        // Ici, nous simulons une route POST qui ajoute la commande √† la DB.
        const response = await securedFetch('/commande_post', { // Supposons que vous cr√©ez une route POST /commande_post qui ajoute √† la DB
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command: commandValue })
        });

        if (response.ok) {
            responseDiv.innerHTML = `<span class="success">‚úÖ Commande enregistr√©e : ${commandValue}</span>`;
            // Pour l'exemple, nous allons simuler l'envoi de la commande √† une route fictive
        } else {
            responseDiv.innerHTML = `<span class="error">‚ùå Erreur d'enregistrement (Statut: ${response.status}) : ${response.text}</span>`;
        }
    }

    // 2. Affichage des commandes
    async function getAllCommands() {
        const responseDiv = document.getElementById('all-commands-display');
        responseDiv.textContent = 'Chargement...';

        const response = await securedFetch('/all_commands');

        if (response.ok && response.json) {
            const data = response.json;
            if (data.success && data.commands.length > 0) {
                let html = '<table><tr><th>ID</th><th>Commande</th><th>Date</th></tr>';
                data.commands.forEach(cmd => {
                    const date = new Date(cmd.created_at).toLocaleString('fr-FR');
                    html += `<tr><td>${cmd.id}</td><td>${cmd.command}</td><td>${date}</td></tr>`;
                });
                html += '</table>';
                responseDiv.innerHTML = html;
            } else {
                responseDiv.innerHTML = '<span class="error">Aucune commande trouv√©e.</span>';
            }
        } else {
            responseDiv.innerHTML = `<span class="error">‚ùå Erreur lors de la r√©cup√©ration des commandes (Statut: ${response.status}).</span>`;
        }
    }
    
    // Afficher la derni√®re commande (Texte Brut)
    async function getAndDisplayLastCommand() {
        const responseDiv = document.getElementById('all-commands-display');
        responseDiv.textContent = 'Chargement de la derni√®re commande...';

        const response = await securedFetch('/last_command'); // Route texte brut

        if (response.ok) {
            responseDiv.innerHTML = `<p><strong>Derni√®re Commande (Texte Brut):</strong></p><pre>${response.text}</pre>`;
        } else {
            responseDiv.innerHTML = `<span class="error">‚ùå Erreur lors de la r√©cup√©ration de la derni√®re commande (Statut: ${response.status}).</span>`;
        }
    }

    // 3. Affichage des messages ESP
    async function getEspMessages() {
        const responseDiv = document.getElementById('esp-messages-display');
        responseDiv.textContent = 'Chargement...';

        const response = await securedFetch('/messages');

        if (response.ok && response.json) {
            const data = response.json;
            if (data.success && data.messages.length > 0) {
                let html = `<h4>Total Messages: ${data.count}</h4><table><tr><th>Device ID</th><th>Message</th><th>Date</th></tr>`;
                data.messages.forEach(msg => {
                    const date = new Date(msg.created_at).toLocaleTimeString('fr-FR');
                    html += `<tr><td>${msg.device_id}</td><td>${msg.message}</td><td>${date}</td></tr>`;
                });
                html += '</table>';
                responseDiv.innerHTML = html;
            } else {
                responseDiv.innerHTML = '<span class="error">Aucun message ESP en RAM.</span>';
            }
        } else {
            responseDiv.innerHTML = `<span class="error">‚ùå Erreur lors de la r√©cup√©ration des messages ESP (Statut: ${response.status}).</span>`;
        }
    }

    // 4. Affichage du Statut du Serveur
    async function getServerStatus() {
        const responseDiv = document.getElementById('status-response');
        responseDiv.textContent = 'Chargement...';

        const response = await securedFetch('/status');

        if (response.ok && response.json) {
            const data = response.json;
            let html = `
                <p><strong>Service:</strong> ${data.service}</p>
                <p><strong>Statut:</strong> <span class="${data.status === 'online' ? 'success' : 'error'}">${data.status}</span></p>
                <p><strong>Statut DB:</strong> ${data.db_status}</p>
                <p><strong>Routes Disponibles (${data.routes_available.length}):</strong></p>
                <ul>
                    ${data.routes_available.map(r => `<li>${r}</li>`).join('')}
                </ul>
                <p><strong>Timestamp:</strong> ${data.timestamp}</p>
            `;
            responseDiv.innerHTML = html;
        } else {
            responseDiv.innerHTML = `<span class="error">‚ùå Erreur lors de la r√©cup√©ration du statut (Statut: ${response.status}).</span>`;
        }
    }
    
    // Tente de se connecter au chargement pour un environnement de d√©veloppement
    window.onload = () => {
        handleLogin(); // Tente de se connecter avec les valeurs par d√©faut
    };
</script>

</body>
</html>
