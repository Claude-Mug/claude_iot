<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>IoT Commandes</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h2 class="text-center mb-4">üåê Interface IoT ‚Äì Gestion des Commandes</h2>

      <div id="root"></div>
    </div>

    <script type="text/babel">
      const API_URL = window.location.origin;

      function App() {
        const [commandes, setCommandes] = React.useState([]);
        const [newCommand, setNewCommand] = React.useState("");

        // Charger les commandes au d√©marrage
        React.useEffect(() => {
          fetch(`${API_URL}/commands`)
            .then((res) => res.json())
            .then((data) => setCommandes(data))
            .catch((err) => console.error("Erreur chargement commandes :", err));
        }, []);

        // Envoyer une commande
        const sendCommand = async () => {
          if (!newCommand.trim()) return alert("Entrez une commande !");
          try {
            const res = await fetch(`${API_URL}/set_command`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ command: newCommand }),
            });
            const data = await res.json();
            if (data.success) {
              alert(`‚úÖ Commande envoy√©e : ${data.command}`);
              setNewCommand("");
              // Recharger les commandes
              fetch(`${API_URL}/commands`)
                .then((res) => res.json())
                .then((data) => setCommandes(data));
            }
          } catch (err) {
            alert("Erreur d‚Äôenvoi de la commande !");
          }
        };

        return (
          <div>
            <div className="input-group mb-3">
              <input
                type="text"
                className="form-control"
                placeholder="Entrer une commande (ex: allumer_led)"
                value={newCommand}
                onChange={(e) => setNewCommand(e.target.value)}
              />
              <button className="btn btn-primary" onClick={sendCommand}>
                Envoyer
              </button>
            </div>

            <h5>üìã Historique des commandes :</h5>
            <table className="table table-striped">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Commande</th>
                  <th>Date / Heure</th>
                </tr>
              </thead>
              <tbody>
                {commandes.length > 0 ? (
                  commandes.map((cmd) => (
                    <tr key={cmd.id}>
                      <td>{cmd.id}</td>
                      <td>{cmd.command}</td>
                      <td>
                        {new Date(cmd.created_at).toLocaleString("fr-FR", {
                          dateStyle: "short",
                          timeStyle: "medium",
                        })}
                      </td>
                    </tr>
                  ))
                ) : (
                  <tr>
                    <td colSpan="3" className="text-center">
                      Aucune commande enregistr√©e
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
