<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>ğŸŒ IoT Dashboard â€“ Commandes</title>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f8f9fa;
      }
      .card {
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }
      .btn-danger {
        font-size: 0.85rem;
      }
      .login-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .login-card {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        text-align: center;
      }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      const API_URL = window.location.origin;

      function App() {
        const [authenticated, setAuthenticated] = React.useState(false);
        const [commandes, setCommandes] = React.useState([]);
        const [messages, setMessages] = React.useState([]);
        const [newCommand, setNewCommand] = React.useState("");
        const [stats, setStats] = React.useState({
          total: 0,
          mem: "0 Mo",
        });
        const [routes, setRoutes] = React.useState([]);

        // === Authentification simple ===
        const handleLogin = () => {
          const user = prompt("ğŸ‘¤ Nom d'utilisateur :");
          const pass = prompt("ğŸ”’ Mot de passe :");
          if (user === "Claude-Mug" && pass === "Moscouw03") {
            setAuthenticated(true);
          } else {
            alert("âŒ AccÃ¨s refusÃ© !");
          }
        };

        // Charger les donnÃ©es
        const loadData = async () => {
          try {
            const resCmd = await fetch(`${API_URL}/commands`);
            const cmdData = await resCmd.json();
            setCommandes(cmdData);

            // RÃ©cupÃ©rer les messages temporaires
            const resMsg = await fetch(`${API_URL}/messages`);
            const msgData = await resMsg.json();
            setMessages(msgData);

            // RÃ©cupÃ©rer les routes du serveur
            const resRoutes = await fetch(`${API_URL}/routes_info`);
            const routesData = await resRoutes.json();
            setRoutes(routesData.routes);

            // Calcul mÃ©moire utilisÃ©e cÃ´tÃ© navigateur (simple approximation)
            const memUsed =
              (performance.memory?.usedJSHeapSize || 0) / 1024 / 1024;

            setStats({
              total: cmdData.length,
              mem: memUsed.toFixed(2) + " Mo",
            });
          } catch (err) {
            console.error("Erreur de chargement :", err);
          }
        };

        React.useEffect(() => {
          if (authenticated) {
            loadData();
            const interval = setInterval(loadData, 10000);
            return () => clearInterval(interval);
          }
        }, [authenticated]);

        // === Envoyer une commande ===
        const sendCommand = async () => {
          if (!newCommand.trim()) return alert("âš ï¸ Entrez une commande !");
          try {
            const res = await fetch(`${API_URL}/set_command`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ command: newCommand }),
            });
            const data = await res.json();
            if (data.success) {
              setNewCommand("");
              loadData();
            } else {
              alert("âŒ Erreur dâ€™envoi");
            }
          } catch (err) {
            alert("âŒ Serveur injoignable !");
          }
        };

        if (!authenticated) {
          return (
            <div className="login-overlay">
              <div className="login-card">
                <h4>ğŸ” AccÃ¨s sÃ©curisÃ©</h4>
                <p>Veuillez vous connecter pour accÃ©der au tableau de bord.</p>
                <button className="btn btn-primary" onClick={handleLogin}>
                  Se connecter
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className="container py-4">
            <h2 className="text-center mb-4 fw-bold text-primary">
              ğŸŒ Tableau de bord IoT â€“ Gestion des Commandes
            </h2>

            {/* === Stats === */}
            <div className="row mb-4">
              <div className="col-md-6">
                <div className="card text-center p-3">
                  <h5>ğŸ“¦ Total Commandes</h5>
                  <h3 className="text-primary">{stats.total}</h3>
                </div>
              </div>
              <div className="col-md-6">
                <div className="card text-center p-3">
                  <h5>ğŸ’¾ MÃ©moire utilisÃ©e (navigateur)</h5>
                  <p className="fw-bold text-success">{stats.mem}</p>
                </div>
              </div>
            </div>

            {/* === Formulaire === */}
            <div className="input-group mb-4">
              <input
                type="text"
                className="form-control"
                placeholder="Ex: Lampes_on"
                value={newCommand}
                onChange={(e) => setNewCommand(e.target.value)}
              />
              <button className="btn btn-primary" onClick={sendCommand}>
                â• Envoyer
              </button>
            </div>

            {/* === Commandes === */}
            <div className="card p-3 mb-4">
              <h5>ğŸ“‹ Commandes en mÃ©moire :</h5>
              <table className="table table-hover mt-3">
                <thead className="table-primary">
                  <tr>
                    <th>#</th>
                    <th>Commande</th>
                    <th>Date / Heure</th>
                  </tr>
                </thead>
                <tbody>
                  {commandes.length > 0 ? (
                    commandes.map((cmd) => (
                      <tr key={cmd.id}>
                        <td>{cmd.id}</td>
                        <td>{cmd.command}</td>
                        <td>
                          {new Date(cmd.created_at).toLocaleString("fr-FR")}
                        </td>
                      </tr>
                    ))
                  ) : (
                    <tr>
                      <td colSpan="3" className="text-center text-muted">
                        Aucune commande
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>

            {/* === Messages === */}
            <div className="card p-3 mb-4">
              <h5>ğŸ“¨ Messages reÃ§us (ESP â†’ Serveur) :</h5>
              {messages.length > 0 ? (
                <ul className="list-group mt-3">
                  {messages.map((msg, i) => (
                    <li key={i} className="list-group-item">
                      ğŸ•’ {msg.time} â€” <strong>{msg.text}</strong>
                    </li>
                  ))}
                </ul>
              ) : (
                <p className="text-muted">Aucun message reÃ§u</p>
              )}
            </div>

            {/* === Routes disponibles === */}
            <div className="card p-3">
              <h5>ğŸ›£ï¸ Routes disponibles :</h5>
              <ul className="list-group mt-3">
                {routes.map((r, i) => (
                  <li key={i} className="list-group-item">
                    <strong>{r.method}</strong> â†’ {r.path}
                  </li>
                ))}
              </ul>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
