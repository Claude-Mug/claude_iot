<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>ğŸŒ IoT Dashboard â€“ Commandes</title>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f8f9fa;
      }
      .card {
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }
      .btn-danger {
        font-size: 0.85rem;
      }
    </style>
  </head>

  <body>
    <div class="container py-4">
      <h2 class="text-center mb-4 fw-bold text-primary">
        ğŸŒ Tableau de bord IoT â€“ Gestion des Commandes
      </h2>
      <div id="root"></div>
    </div>

    <script type="text/babel">
      const API_URL = window.location.origin;

      function App() {
        const [commandes, setCommandes] = React.useState([]);
        const [newCommand, setNewCommand] = React.useState("");
        const [stats, setStats] = React.useState({
          total: 0,
          last: "Aucune",
          lastDate: "-",
        });

        // Charger les commandes + infos
        const loadData = async () => {
          try {
            const res = await fetch(`${API_URL}/commands`);
            const data = await res.json();
            setCommandes(data);

            if (data.length > 0) {
              const last = data[data.length - 1];
              setStats({
                total: data.length,
                last: last.command,
                lastDate: new Date(last.created_at).toLocaleString("fr-FR"),
              });
            } else {
              setStats({ total: 0, last: "Aucune", lastDate: "-" });
            }
          } catch (err) {
            console.error("Erreur de chargement :", err);
          }
        };

        React.useEffect(() => {
          loadData();
          const interval = setInterval(loadData, 10000); // auto-refresh
          return () => clearInterval(interval);
        }, []);

        // Envoyer une commande
        const sendCommand = async () => {
          if (!newCommand.trim()) return alert("âš ï¸ Entrez une commande !");
          try {
            const res = await fetch(`${API_URL}/set_command`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ command: newCommand }),
            });
            const data = await res.json();
            if (data.success) {
              setNewCommand("");
              loadData();
            } else {
              alert("âŒ Erreur lors de lâ€™envoi");
            }
          } catch (err) {
            alert("âŒ Serveur injoignable !");
          }
        };

        // Supprimer une commande
        const deleteCommand = async (id) => {
          if (!confirm("Voulez-vous vraiment supprimer cette commande ?")) return;
          try {
            const res = await fetch(`${API_URL}/delete_command/${id}`, {
              method: "DELETE",
            });
            const data = await res.json();
            if (data.success) loadData();
            else alert("Erreur suppression !");
          } catch (err) {
            alert("Erreur rÃ©seau !");
          }
        };

        return (
          <div>
            {/* === Section Informations === */}
            <div className="row mb-4">
              <div className="col-md-4">
                <div className="card text-center p-3">
                  <h5>ğŸ“¦ Total Commandes</h5>
                  <h3 className="text-primary">{stats.total}</h3>
                </div>
              </div>
              <div className="col-md-4">
                <div className="card text-center p-3">
                  <h5>ğŸ•’ DerniÃ¨re commande</h5>
                  <p className="fw-bold">{stats.last}</p>
                  <small className="text-muted">{stats.lastDate}</small>
                </div>
              </div>
              <div className="col-md-4">
                <div className="card text-center p-3">
                  <h5>ğŸ”„ Actualisation</h5>
                  <p className="text-success">Toutes les 10 secondes</p>
                </div>
              </div>
            </div>

            {/* === Formulaire dâ€™ajout === */}
            <div className="input-group mb-4">
              <input
                type="text"
                className="form-control"
                placeholder="Entrez une commande (ex: allumer_led)"
                value={newCommand}
                onChange={(e) => setNewCommand(e.target.value)}
              />
              <button className="btn btn-primary" onClick={sendCommand}>
                â• Envoyer
              </button>
            </div>

            {/* === Tableau des commandes === */}
            <div className="card p-3">
              <h5>ğŸ“‹ Historique des commandes :</h5>
              <table className="table table-hover mt-3">
                <thead className="table-primary">
                  <tr>
                    <th>ID</th>
                    <th>Commande</th>
                    <th>Date / Heure</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {commandes.length > 0 ? (
                    commandes.map((cmd) => (
                      <tr key={cmd.id}>
                        <td>{cmd.id}</td>
                        <td>{cmd.command}</td>
                        <td>
                          {new Date(cmd.created_at).toLocaleString("fr-FR", {
                            dateStyle: "short",
                            timeStyle: "medium",
                          })}
                        </td>
                        <td>
                          <button
                            className="btn btn-sm btn-danger"
                            onClick={() => deleteCommand(cmd.id)}
                          >
                            ğŸ—‘ï¸ Supprimer
                          </button>
                        </td>
                      </tr>
                    ))
                  ) : (
                    <tr>
                      <td colSpan="4" className="text-center text-muted">
                        Aucune commande enregistrÃ©e
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
