<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>üåê IoT Dashboard ‚Äì Connexion & Commandes</title>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f0f4f8;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      h2,
      h4 {
        font-weight: 600;
      }

      .login-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #007bff, #6610f2);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .login-card {
        background: white;
        width: 350px;
        padding: 40px 30px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
        text-align: center;
      }

      .login-card h3 {
        font-weight: bold;
        margin-bottom: 15px;
      }

      .login-card input {
        margin-bottom: 15px;
      }

      .card {
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }

      footer {
        text-align: center;
        margin-top: 30px;
        color: #777;
        font-size: 0.85rem;
      }

      .btn-primary {
        background: linear-gradient(135deg, #007bff, #6610f2);
        border: none;
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #6610f2, #007bff);
      }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      const API_URL = "https://claude-iot.onrender.com"; // üîó Ton serveur Render

      function App() {
        const [authenticated, setAuthenticated] = React.useState(false);
        const [username, setUsername] = React.useState("");
        const [password, setPassword] = React.useState("");
        const [commandes, setCommandes] = React.useState([]);
        const [messages, setMessages] = React.useState([]);
        const [newCommand, setNewCommand] = React.useState("");
        const [stats, setStats] = React.useState({ total: 0, mem: "0 Mo" });
        const [routes, setRoutes] = React.useState([]);

        // === Authentification c√¥t√© client ===
        const handleLogin = (e) => {
          e.preventDefault();
          if (username === "Claude-Mug" && password === "Moscouw03") {
            setAuthenticated(true);
          } else {
            alert("‚ùå Nom d'utilisateur ou mot de passe incorrect !");
          }
        };

        // === Chargement des donn√©es ===
        const loadData = async () => {
          try {
            const [cmdRes, msgRes, statusRes] = await Promise.all([
              fetch(`${API_URL}/commands`),
              fetch(`${API_URL}/messages`),
              fetch(`${API_URL}/status`),
            ]);

            const cmdData = await cmdRes.json();
            const msgData = await msgRes.json();
            const statusData = await statusRes.json();

            setCommandes(cmdData);
            setMessages(msgData);
            setRoutes(statusData.routes_disponibles || []);

            setStats({
              total: cmdData.length,
              mem: statusData.memoire_utilisee || "N/A",
            });
          } catch (err) {
            console.error("Erreur de chargement :", err);
          }
        };

        React.useEffect(() => {
          if (authenticated) {
            loadData();
            const interval = setInterval(loadData, 8000);
            return () => clearInterval(interval);
          }
        }, [authenticated]);

        // === Envoi d'une commande ===
        const sendCommand = async () => {
          if (!newCommand.trim()) return alert("‚ö†Ô∏è Entrez une commande !");
          try {
            const res = await fetch(`${API_URL}/set_command`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ command: newCommand }),
            });
            const data = await res.json();
            if (data.success) {
              setNewCommand("");
              loadData();
            } else {
              alert("‚ùå Erreur d‚Äôenvoi : " + (data.message || "inconnue"));
            }
          } catch (err) {
            alert("‚ùå Serveur injoignable !");
          }
        };

        // === UI: Formulaire de connexion ===
        if (!authenticated) {
          return (
            <div className="login-overlay">
              <form className="login-card" onSubmit={handleLogin}>
                <h3>üîê Connexion S√©curis√©e</h3>
                <p className="text-muted mb-3">
                  Acc√©dez √† votre tableau de bord IoT
                </p>
                <input
                  type="text"
                  className="form-control"
                  placeholder="Nom d'utilisateur"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  required
                />
                <input
                  type="password"
                  className="form-control"
                  placeholder="Mot de passe"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                />
                <button type="submit" className="btn btn-primary w-100">
                  Se connecter
                </button>
              </form>
            </div>
          );
        }

        // === UI principale ===
        return (
          <div className="container py-4">
            <h2 className="text-center mb-4 text-primary fw-bold">
              üåê Tableau de Bord IoT
            </h2>

            {/* === Statistiques === */}
            <div className="row mb-4">
              <div className="col-md-6">
                <div className="card text-center p-3">
                  <h5>üì¶ Total Commandes</h5>
                  <h3 className="text-primary">{stats.total}</h3>
                </div>
              </div>
              <div className="col-md-6">
                <div className="card text-center p-3">
                  <h5>üíæ M√©moire utilis√©e</h5>
                  <p className="fw-bold text-success">{stats.mem}</p>
                </div>
              </div>
            </div>

            {/* === Formulaire === */}
            <div className="input-group mb-4">
              <input
                type="text"
                className="form-control"
                placeholder="Ex: led1_on"
                value={newCommand}
                onChange={(e) => setNewCommand(e.target.value)}
              />
              <button className="btn btn-primary" onClick={sendCommand}>
                ‚ûï Envoyer
              </button>
            </div>

            {/* === Commandes et messages === */}
            <div className="row">
              <div className="col-md-6">
                <div className="card p-3 mb-4">
                  <h5>üìã Commandes enregistr√©es :</h5>
                  <table className="table table-hover mt-3">
                    <thead className="table-primary">
                      <tr>
                        <th>#</th>
                        <th>Commande</th>
                        <th>Date / Heure</th>
                      </tr>
                    </thead>
                    <tbody>
                      {commandes.length > 0 ? (
                        commandes.map((cmd) => (
                          <tr key={cmd.id}>
                            <td>{cmd.id}</td>
                            <td>{cmd.command}</td>
                            <td>
                              {cmd.date_creation
                                ? new Date(cmd.date_creation).toLocaleString(
                                    "fr-FR"
                                  )
                                : "-"}
                            </td>
                          </tr>
                        ))
                      ) : (
                        <tr>
                          <td colSpan="3" className="text-center text-muted">
                            Aucune commande
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              <div className="col-md-6">
                <div className="card p-3 mb-4">
                  <h5>üì® Messages ESP :</h5>
                  {messages.length > 0 ? (
                    <ul className="list-group mt-3">
                      {messages.map((msg) => (
                        <li key={msg.id} className="list-group-item">
                          üïí {msg.timestamp
                            ? new Date(msg.timestamp).toLocaleTimeString("fr-FR")
                            : ""}{" "}
                          ‚Äî <strong>{msg.message}</strong>
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <p className="text-muted">Aucun message re√ßu</p>
                  )}
                </div>
              </div>
            </div>

            {/* === Routes disponibles === */}
            <div className="card p-3 mb-4">
              <h5>üõ£Ô∏è Routes disponibles :</h5>
              <ul className="list-group mt-3">
                {routes.map((r, i) => (
                  <li key={i} className="list-group-item">
                    <code>{r}</code>
                  </li>
                ))}
              </ul>
            </div>

            <footer>¬© 2025 Claude IoT Dashboard</footer>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
